import sailpoint.api.SailPointContext;
import sailpoint.api.EmailService;
import sailpoint.object.EmailOptions;
import sailpoint.object.EmailTemplate;
import sailpoint.object.Identity;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;

import java.io.File;
import java.io.FileWriter;
import java.util.ArrayList;
import java.util.List;

public void generateCsvAndSendMail(SailPointContext context, String identityName) throws Exception {

    Connection conn = null;
    PreparedStatement ps = null;
    ResultSet rs = null;
    File csvFile = null;

    try {

        /* =======================
           1. Get DB Connection
           ======================= */
        conn = context.getJdbcConnection("identityiq"); // DataSource name

        String query = "SELECT id, name, email FROM disconnected_applications_metadata";
        ps = conn.prepareStatement(query);
        rs = ps.executeQuery();

        /* =======================
           2. Create CSV File
           ======================= */
        csvFile = File.createTempFile("export_", ".csv");
        FileWriter writer = new FileWriter(csvFile);

        // CSV Header
        writer.append("ID,Name,Email\n");

        while (rs.next()) {
            writer.append(rs.getString("id")).append(",");
            writer.append(rs.getString("name")).append(",");
            writer.append(rs.getString("email")).append("\n");
        }

        writer.flush();
        writer.close();

        /* =======================
           3. Prepare Email
           ======================= */
        Identity identity = context.getObjectByName(Identity.class, identityName);

        EmailTemplate template = new EmailTemplate();
        template.setName("DB CSV Export Mail");
        template.setSubject("Database Export CSV");
        template.setBody("Hello $identityName,\n\nPlease find the attached CSV file.\n\nRegards,\nIAM Team");

        EmailOptions options = new EmailOptions();
        options.setTo(identity.getEmail());
        options.setVariable("identityName", identity.getName());

        // Attach CSV
        options.addAttachment(csvFile.getName(), csvFile);

        EmailService emailService = new EmailService(context);
        emailService.sendEmail(template, options);

    } finally {

        /* =======================
           4. Cleanup
           ======================= */
        if (rs != null) rs.close();
        if (ps != null) ps.close();
        if (conn != null) conn.close();

        if (csvFile != null && csvFile.exists()) {
            csvFile.delete();
        }
    }
}
